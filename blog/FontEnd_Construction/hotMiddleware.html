<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>hotMiddleware 源码解析 | Styx</title>
    <meta name="description" content="Just playing around">
    <meta name="generator" content="VuePress 1.3.1">
    
    
    <link rel="preload" href="/assets/css/0.styles.69dbb021.css" as="style"><link rel="preload" href="/assets/js/app.0e898f27.js" as="script"><link rel="preload" href="/assets/js/2.7a648a06.js" as="script"><link rel="preload" href="/assets/js/8.0812829e.js" as="script"><link rel="prefetch" href="/assets/js/10.79796125.js"><link rel="prefetch" href="/assets/js/11.ad355a29.js"><link rel="prefetch" href="/assets/js/12.86498eb3.js"><link rel="prefetch" href="/assets/js/13.0571d7ba.js"><link rel="prefetch" href="/assets/js/14.f08eec84.js"><link rel="prefetch" href="/assets/js/15.62c9c0fc.js"><link rel="prefetch" href="/assets/js/16.4a371758.js"><link rel="prefetch" href="/assets/js/17.dbd9e19b.js"><link rel="prefetch" href="/assets/js/18.d574a670.js"><link rel="prefetch" href="/assets/js/19.1b6cdbfe.js"><link rel="prefetch" href="/assets/js/20.2b739aa0.js"><link rel="prefetch" href="/assets/js/21.5a1982ed.js"><link rel="prefetch" href="/assets/js/22.65408d3d.js"><link rel="prefetch" href="/assets/js/23.f485509e.js"><link rel="prefetch" href="/assets/js/24.1d639adb.js"><link rel="prefetch" href="/assets/js/25.920f4604.js"><link rel="prefetch" href="/assets/js/26.f7dadedb.js"><link rel="prefetch" href="/assets/js/27.1817c86d.js"><link rel="prefetch" href="/assets/js/28.ea891a46.js"><link rel="prefetch" href="/assets/js/29.186610e5.js"><link rel="prefetch" href="/assets/js/3.3a1f0e6b.js"><link rel="prefetch" href="/assets/js/4.2b2cd21e.js"><link rel="prefetch" href="/assets/js/5.25e441f8.js"><link rel="prefetch" href="/assets/js/6.70d1adeb.js"><link rel="prefetch" href="/assets/js/7.442d54db.js"><link rel="prefetch" href="/assets/js/9.d8f74853.js">
    <link rel="stylesheet" href="/assets/css/0.styles.69dbb021.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Styx</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Blog" class="dropdown-title"><span class="title">Blog</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/JavaScript/" class="nav-link">
  JavaScipt
</a></li><li class="dropdown-item"><!----> <a href="/blog/Node/" class="nav-link">
  Node
</a></li><li class="dropdown-item"><!----> <a href="/blog/FontEnd_Construction/" class="nav-link router-link-active">
  前端构建
</a></li></ul></div></div><div class="nav-item"><a href="/blog/Projects/" class="nav-link">
  Projects
</a></div><div class="nav-item"><a href="https://github.com/Styx11" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Blog" class="dropdown-title"><span class="title">Blog</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/JavaScript/" class="nav-link">
  JavaScipt
</a></li><li class="dropdown-item"><!----> <a href="/blog/Node/" class="nav-link">
  Node
</a></li><li class="dropdown-item"><!----> <a href="/blog/FontEnd_Construction/" class="nav-link router-link-active">
  前端构建
</a></li></ul></div></div><div class="nav-item"><a href="/blog/Projects/" class="nav-link">
  Projects
</a></div><div class="nav-item"><a href="https://github.com/Styx11" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/blog/FontEnd_Construction/" class="sidebar-link">Babel 转码器的使用</a></li><li><a href="/blog/FontEnd_Construction/use_eslint.html" class="sidebar-link">ESLint 规范代码</a></li><li><a href="/blog/FontEnd_Construction/module_basic.html" class="sidebar-link">ES6 Module 基本语法</a></li><li><a href="/blog/FontEnd_Construction/ssr_first_part.html" class="sidebar-link">SSR 构建流程（上）</a></li><li><a href="/blog/FontEnd_Construction/ssr_second_part.html" class="sidebar-link">SSR 构建流程（中）</a></li><li><a href="/blog/FontEnd_Construction/ssr_third_part.html" class="sidebar-link">SSR 构建流程（下）</a></li><li><a href="/blog/FontEnd_Construction/devMiddleware.html" class="sidebar-link">devMiddleware 源码解析</a></li><li><a href="/blog/FontEnd_Construction/hotMiddleware.html" class="active sidebar-link">hotMiddleware 源码解析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/FontEnd_Construction/hotMiddleware.html#前言" class="sidebar-link">前言</a></li><li class="sidebar-sub-header"><a href="/blog/FontEnd_Construction/hotMiddleware.html#这是什么？" class="sidebar-link">这是什么？</a></li><li class="sidebar-sub-header"><a href="/blog/FontEnd_Construction/hotMiddleware.html#它是如何工作的" class="sidebar-link">它是如何工作的</a></li><li class="sidebar-sub-header"><a href="/blog/FontEnd_Construction/hotMiddleware.html#server-sent-events" class="sidebar-link">Server-sent Events</a></li><li class="sidebar-sub-header"><a href="/blog/FontEnd_Construction/hotMiddleware.html#middleware" class="sidebar-link">middleware</a></li><li class="sidebar-sub-header"><a href="/blog/FontEnd_Construction/hotMiddleware.html#client" class="sidebar-link">client</a></li><li class="sidebar-sub-header"><a href="/blog/FontEnd_Construction/hotMiddleware.html#还有一件事" class="sidebar-link">还有一件事</a></li><li class="sidebar-sub-header"><a href="/blog/FontEnd_Construction/hotMiddleware.html#写在最后" class="sidebar-link">写在最后</a></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="hotmiddleware-源码解析"><a href="#hotmiddleware-源码解析" class="header-anchor">#</a> hotMiddleware 源码解析</h1> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>文章所描述的构建场景基于 Koa2 和 Webpack4</p> <p>使用依赖版本以及样例源码参考 <a href="https://github.com/Styx11/vue-ssr-base" target="_blank" rel="noopener noreferrer">https://github.com/Styx11/vue-ssr-base<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><strong>原创文章，转载请联系作者<a href="https://github.com/Styx11" target="_blank" rel="noopener noreferrer">Styx<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>！</strong></p></div> <h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>这篇解析依然衍生于我的 <a href="/blog/FontEnd_Construction/ssr_third_part.html">SSR 构建流程</a>总结，我认为理解 hotMiddleware 中间件为我们所做的工作和了解它所使用的通信方式是有帮助的，这其中涉及了 Server-sent Events（SSEs）——一种高效的单向通信技术。在这篇文章中我使用<a href="https://github.com/webpack-contrib/webpack-hot-middleware/tree/v2.25.0" target="_blank" rel="noopener noreferrer">webpack-hot-middlewarev2.25.0<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>版本源码并做精简以向你展示这一过程，希望对你在服务端事件的应用上有所启发。</p> <p>注意：英文注释是源码作者标注的，中文注释是我额外添加的，这些可以帮助你更好地理解代码</p> <h2 id="这是什么？"><a href="#这是什么？" class="header-anchor">#</a> 这是什么？</h2> <p>在<a href="/blog/FontEnd_Construction/ssr_third_part.html#devMiddleware">下篇</a>中我们使用了 devMiddleware 帮助我们重新构建 <code>renderer</code> 并向客户端提供新的编译文件以提高开发效率。但这个模式还有一些缺点：我们仍需刷新浏览器去请求新的编译文件然后重建应用，在这个过程中应用的上下文也会丢失，这依然会妨碍我们的开发。</p> <p><strong>模块热替换 HMR</strong>（Hot Module Replacement）功能可以在应用的运行过程中，增添、删除和替换模块，实现了应用程序的更新但不需要刷新浏览器，从而保留了应用的状态大大提高了开发效率。</p> <p>我们先从安装依赖来看看一个普通的例子是如何开始的：</p> <ol start="0"><li>安装依赖：</li></ol> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">npm</span> <span class="token function">install</span> webpack-hot-middleware@2.25.0 --save-dev
</code></pre></div><ol><li>在 Webpack 配置文件中加入相关插件，它让我们可以使用 <a href="https://webpack.docschina.org/api/hot-module-replacement/" target="_blank" rel="noopener noreferrer">HMR API<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>：</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// lib/webpack.dev.js</span>
<span class="token keyword">const</span> webpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> merge <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-merge'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> baseConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./webpack.base.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">merge</span><span class="token punctuation">(</span>baseConfig<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token comment">//...</span>

  <span class="token comment">// 注意：你只应该在开发模式下使用它</span>
  plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>HotModuleReplacementPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">//...</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ol start="2"><li><p>将<code>webpack-hot-middleware/client</code>加入客户端 Webpack 配置的入口配置（<code>entry</code>）数组中，它的作用我们之后会看到。</p></li> <li><p>加入<code>webpack-dev-middleware</code>中间件，这当然是必须的，因为它为浏览器提供了编译文件：</p></li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> webpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> webpackConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./webpack.config'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> compiler <span class="token operator">=</span> <span class="token function">webpack</span><span class="token punctuation">(</span>webpackConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;webpack-dev-middleware&quot;</span><span class="token punctuation">)</span><span class="token punctuation">(</span>compiler<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    noInfo<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> publicPath<span class="token operator">:</span> webpackConfig<span class="token punctuation">.</span>output<span class="token punctuation">.</span>publicPath
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ol start="4"><li>最后将<code>webpack-hot-middleware</code>加入我们的服务端应用：</li></ol> <div class="language-js extra-class"><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-hot-middleware'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>complier<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这就是我们在一个普通应用中需要做的，这个时候照常启动开发服务器然后尝试修改相关的客户端代码，我们就可以看到在没有刷新的情况下应用程序发生了变化，和手动刷新浏览器的效果一样。</p> <h2 id="它是如何工作的"><a href="#它是如何工作的" class="header-anchor">#</a> 它是如何工作的</h2> <p>让我们来看看 hotMiddleware 的 <a href="https://github.com/webpack-contrib/webpack-hot-middleware/tree/v2.25.0#how-it-works" target="_blank" rel="noopener noreferrer">README<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 是如何解释它的工作原理的：</p> <blockquote><p>The middleware installs itself as a webpack plugin, and <strong>listens</strong> for compiler events. Each connected client gets a <strong>Server Sent Events</strong> connection, the server will <strong>publish</strong> notifications to connected clients on compiler events. When the client receives a message, it will <strong>check</strong> to see if the local code is up to date. If it isn't up to date, it will <strong>trigger</strong> webpack hot module reloading.</p></blockquote> <p>我们可以通过上面的说明将 hotMiddleware 的工作原理进行以下划分：首先在服务端，它作为中间件回复、处理特定请求，并开启 Server Sent Events（SSEs）服务，然后注册 Webpack 的编译钩子以便在文件变动时向客户端发送通知（notifications）；接着在客户端，它会订阅这个 SSEs 服务，并在服务端有事件通知发出时调用 HMR API 进行检查并更新模块。</p> <p>这就有点神奇了！hotMiddleware 是怎么做到既在服务端作为中间件，又在客户端监听事件的呢？这和我们平时使用的中间件是截然不同的，下面我先介绍让这一切能够发生的 SSEs 技术</p> <h2 id="server-sent-events"><a href="#server-sent-events" class="header-anchor">#</a> Server-sent Events</h2> <p>我们在生活中经常会遇到诸如消息动态实时更新的场景，在早些时候要实现类似这样服务端事件同步更新到客户端的操作，通常会选择“长轮询”（Long polling），也就是由客户端发起一个请求，查询服务端是否有新的事件发生，有则返回，无则由服务端挂起（hanging）这个请求直到发生事件然后返回给客户端。但是这是一种“hack”级别的方法，它不是技术上的一种标准并且也只是结果上实现了事件”同步“，这就意味着无论如何它都不会特别高效，离真正的事件同步有一定的距离。</p> <p>Server-sent Events（SSEs）从底层就被设计为一个高效且节省资源的单向同步技术，它基于现有的 HTTP 协议，这意味着我们无需从头创建一个基于像 WebSocket 协议那样的服务器。在服务端，我们以<code>Content-Type: text/event-stream</code>头部开启一个 SSEs 服务并可以在任何时候通过发送符合标准的格式化数据向客户端更新事件（event）；在客户端，我们创建一个<code>EventSource</code>对象以订阅（subscribe）这个 SSEs 服务并添加回调函数从而实时地处理相应事件。</p> <p>一个 SSEs 的简单例子：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// server.js</span>
<span class="token comment">//...</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> PassThrough <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'stream'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/event-test'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PassThrough</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'text/event-stream'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 一次事件以 \n\n 为结束标识</span>
    stream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'data: hello\n\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> stream<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">allowedMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>在客户端我们订阅这个 SSEs 服务：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//client.js</span>
<span class="token comment">//...</span>
<span class="token comment">// 注意只能是在同一域名下订阅 SSEs 服务，否则会有跨域请求问题</span>
<span class="token keyword">const</span> event <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventSource</span><span class="token punctuation">(</span><span class="token string">'/event-test'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
event<span class="token punctuation">.</span><span class="token function">onmessage</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token comment">// hello</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
event<span class="token punctuation">.</span><span class="token function">onerror</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  event<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>在上面的例子中，服务端每 1 秒会发出一次事件以模拟实时消息，在客户端我们创建了一个<code>EventSource</code>对象去订阅这个服务，这样每次服务端发出通知时我们的回调函数就会被调用。</p> <p>更多关于 SSEs 的内容可以参考 <a href="https://www.html5rocks.com/en/tutorials/eventsource/basics/" target="_blank" rel="noopener noreferrer">Stream Updates with Server-Sent Events<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，虽然这是一篇英文文章但作者以一种浅显易懂的方式介绍了这个技术。</p> <p>那么对于 hotMiddleware 来说就应该需要服务端和客户端的代码来让这一切工作起来：服务端负责在特定的时候发送事件，客户端在收到事件时检查并更新模块，接下来我们从源码的角度看看它是如何工作的。</p> <h2 id="middleware"><a href="#middleware" class="header-anchor">#</a> middleware</h2> <p>在介绍之间我们先弄清一个概念，我们所说的服务端通知客户端，这里的“客户端”指的是 hotMiddleware 创建的专门用来监听服务端事件并检查更新模块的客户端，而不是发出请求的用户。后面我们会用<code>client</code>专指这一对象。</p> <p>我们先从服务端使用的中间件主体<a href="https://github.com/webpack-contrib/webpack-hot-middleware/blob/v2.25.0/middleware.js" target="_blank" rel="noopener noreferrer">webpack-hot-middleware/middleware.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>看起：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// middleware.js</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> webpackHotMiddleware<span class="token punctuation">;</span>
<span class="token keyword">var</span> helpers <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./helpers'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> pathMatch <span class="token operator">=</span> helpers<span class="token punctuation">.</span>pathMatch<span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">webpackHotMiddleware</span><span class="token punctuation">(</span><span class="token parameter">compiler<span class="token punctuation">,</span> opts</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  opts <span class="token operator">=</span> opts <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  opts<span class="token punctuation">.</span>path <span class="token operator">=</span> opts<span class="token punctuation">.</span>path <span class="token operator">||</span> <span class="token string">'/__webpack_hmr'</span><span class="token punctuation">;</span>
  opts<span class="token punctuation">.</span>heartbeat <span class="token operator">=</span> opts<span class="token punctuation">.</span>heartbeat <span class="token operator">||</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>

  <span class="token comment">// 创建负责 SSEs 相关工作的对象</span>
  <span class="token keyword">var</span> eventStream <span class="token operator">=</span> <span class="token function">createEventStream</span><span class="token punctuation">(</span>opts<span class="token punctuation">.</span>heartbeat<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> latestStats <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> closed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

  <span class="token comment">// 注册编译钩子以在代码变动时向 client 发送通知</span>
  compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>invalid<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'webpack-hot-middleware'</span><span class="token punctuation">,</span> onInvalid<span class="token punctuation">)</span><span class="token punctuation">;</span>
  compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>done<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'webpack-hot-middleware'</span><span class="token punctuation">,</span> onDone<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//...</span>

  <span class="token comment">// eventStream.publish 会向客户端发生事件</span>
  <span class="token keyword">function</span> <span class="token function">onInvalid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>closed<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    latestStats <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    eventStream<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token punctuation">{</span> action<span class="token operator">:</span> <span class="token string">'building'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">onDone</span><span class="token punctuation">(</span><span class="token parameter">statsResult</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>closed<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token comment">// Keep hold of latest stats so they can be propagated to new clients</span>
    latestStats <span class="token operator">=</span> statsResult<span class="token punctuation">;</span>
    <span class="token comment">// publishStats 内部调用了 eventStream.publish</span>
    <span class="token comment">// built 事件会让 client 打印额外的信息，并且最终会 fallthrough 到 sync 事件检查更新</span>
    <span class="token function">publishStats</span><span class="token punctuation">(</span><span class="token string">'built'</span><span class="token punctuation">,</span> latestStats<span class="token punctuation">,</span> eventStream<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>log<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 中间件主体</span>
  <span class="token keyword">var</span> <span class="token function-variable function">middleware</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果不是 client 发出的建立 EventSource 的请求，则 next</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>closed<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">pathMatch</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token punctuation">,</span> opts<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 处理 client 请求</span>
    eventStream<span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>latestStats<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 这就是整个中间件的关键</span>
      <span class="token comment">// sync 事件通知 client 检查更新模块</span>
      <span class="token function">publishStats</span><span class="token punctuation">(</span><span class="token string">'sync'</span><span class="token punctuation">,</span> latestStats<span class="token punctuation">,</span> eventStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">//...</span>
  <span class="token comment">// 我们可以在外部手动关闭 hotMiddleware，虽然一般不这么做</span>
  middleware<span class="token punctuation">.</span><span class="token function-variable function">close</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>closed<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token comment">// Can't remove compiler plugins, so we just set a flag and noop if closed</span>
    <span class="token comment">// https://github.com/webpack/tapable/issues/32#issuecomment-350644466</span>
    closed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    eventStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    eventStream <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> middleware<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//...</span>

<span class="token comment">// 发送事件并附加一些额外的打包信息</span>
<span class="token comment">// 主要会用到 module hash、module id</span>
<span class="token keyword">function</span> <span class="token function">publishStats</span><span class="token punctuation">(</span><span class="token parameter">action<span class="token punctuation">,</span> statsResult<span class="token punctuation">,</span> eventStream<span class="token punctuation">,</span> log</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> stats <span class="token operator">=</span> statsResult<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    all<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    cached<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    children<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    modules<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    timings<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    hash<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// For multi-compiler, stats will be an object with a 'children' array of stats</span>
  <span class="token keyword">var</span> bundles <span class="token operator">=</span> <span class="token function">extractBundles</span><span class="token punctuation">(</span>stats<span class="token punctuation">)</span><span class="token punctuation">;</span>
  bundles<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">stats</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> name <span class="token operator">=</span> stats<span class="token punctuation">.</span>name <span class="token operator">||</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token comment">//...</span>
    eventStream<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      name<span class="token operator">:</span> name<span class="token punctuation">,</span>
      action<span class="token operator">:</span> action<span class="token punctuation">,</span>
      time<span class="token operator">:</span> stats<span class="token punctuation">.</span>time<span class="token punctuation">,</span>
      hash<span class="token operator">:</span> stats<span class="token punctuation">.</span>hash<span class="token punctuation">,</span>
      warnings<span class="token operator">:</span> stats<span class="token punctuation">.</span>warnings <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      errors<span class="token operator">:</span> stats<span class="token punctuation">.</span>errors <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      modules<span class="token operator">:</span> <span class="token function">buildModuleMap</span><span class="token punctuation">(</span>stats<span class="token punctuation">.</span>modules<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">extractBundles</span><span class="token punctuation">(</span><span class="token parameter">stats</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Stats has modules, single bundle</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>stats<span class="token punctuation">.</span>modules<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token punctuation">[</span>stats<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">//...</span>
  <span class="token comment">// Not sure, assume single</span>
  <span class="token keyword">return</span> <span class="token punctuation">[</span>stats<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">buildModuleMap</span><span class="token punctuation">(</span><span class="token parameter">modules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> map <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  modules<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    map<span class="token punctuation">[</span>module<span class="token punctuation">.</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> module<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> map<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>总结一下 hotMiddleware 工厂函数所做的： 创建一个负责 SSEs 相关工作的<code>eventStream</code>对象（目前我们只需要知道<code>eventStream.publish</code>方法会向 client 发送事件通知），并注册了<code>complier</code>编译钩子以在合适的时机发送事件；<code>middleware</code>的主体部分调用<code>eventStream.handle</code>处理且只处理 client 的相关请求。之后调用<code>publishStats</code>函数通知 client 进行一次代码检查。hotMiddleware 还为我们提供了一些接口可以手动关闭 SSEs 服务，虽然一般不会这么做。</p> <p>然后让我们来简单看看<code>createEventStream</code>内部做了什么工作：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// middleware.js</span>
<span class="token comment">//...</span>

<span class="token comment">// heartbeat 定义发送维持连接信息的间隔时间</span>
<span class="token keyword">function</span> <span class="token function">createEventStream</span><span class="token punctuation">(</span><span class="token parameter">heartbeat</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> clientId <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> clients <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">// 向每一个连接的 client 执行 fn</span>
  <span class="token keyword">function</span> <span class="token function">everyClient</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>clients<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">fn</span><span class="token punctuation">(</span>clients<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 维持每个 SSEs 链接防止 client 判断超时 timeout</span>
  <span class="token keyword">var</span> interval <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">heartbeatTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">everyClient</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">client</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      client<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'data: \uD83D\uDC93\n\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> heartbeat<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token comment">// 手动关闭 SSEs 服务</span>
    <span class="token function-variable function">close</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">clearInterval</span><span class="token punctuation">(</span>interval<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">everyClient</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">client</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>client<span class="token punctuation">.</span>finished<span class="token punctuation">)</span> client<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      clients <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 处理 client 请求</span>
    <span class="token function-variable function">handler</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">var</span> headers <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">'Content-Type'</span><span class="token operator">:</span> <span class="token string">'text/event-stream;charset=utf-8'</span><span class="token punctuation">,</span>
        <span class="token comment">//...</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      <span class="token comment">//...</span>
      res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> headers<span class="token punctuation">)</span><span class="token punctuation">;</span>
      res<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> id <span class="token operator">=</span> clientId<span class="token operator">++</span><span class="token punctuation">;</span>
      clients<span class="token punctuation">[</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> res<span class="token punctuation">;</span>
      req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'close'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">.</span>finished<span class="token punctuation">)</span> res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">delete</span> clients<span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">// 向每一个 client 发送通知并附加 payload 数据</span>
    <span class="token function-variable function">publish</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">payload</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">everyClient</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">client</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        client<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'data: '</span> <span class="token operator">+</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'\n\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>由<code>createEventStream</code>工厂函数创建的<code>eventStream</code>对象会用<code>Content-Type: event-stream</code>头回复请求以创建 SSEs 服务，<code>publish</code>方法会向所有连接的 client 发送事件通知并附加一些额外的信息。这样在 client 收到通知后就可以调用回调函数检查更新模块了。在这期间它还会不断发送维持信息<code>data: \uD83D\uDC93\n\n</code>让 client 知道服务还在继续并没有中断。</p> <p>以上就是 hotMiddleware 作为服务端中间件的源码内容了，我们可以发现它只是做了发送事件通知 client 的工作，对我们的应用并没有什么作用，关键还是要看运行在客户端的 client 会在事件发生时做什么。接下来我们看看它是如何影响我们的应用的。</p> <h2 id="client"><a href="#client" class="header-anchor">#</a> client</h2> <p>我们从<a href="https://github.com/webpack-contrib/webpack-hot-middleware/blob/v2.25.0/client.js" target="_blank" rel="noopener noreferrer">webpack-hot-middleware/client.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>看起（我会把一些非重点的代码忽略掉）：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// client.js</span>
<span class="token comment">// 运行在浏览器环境中</span>
<span class="token comment">/*eslint-env browser*/</span>
<span class="token comment">/*global __resourceQuery __webpack_public_path__*/</span>

<span class="token keyword">var</span> options <span class="token operator">=</span> <span class="token punctuation">{</span>
  path<span class="token operator">:</span> <span class="token string">'/__webpack_hmr'</span><span class="token punctuation">,</span>
  timeout<span class="token operator">:</span> <span class="token number">20</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">,</span>
  log<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  warn<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  reload<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  name<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
  autoConnect<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token comment">//...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">//...</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> window <span class="token operator">===</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// do nothing</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> window<span class="token punctuation">.</span>EventSource <span class="token operator">===</span> <span class="token string">'undefined'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>
    <span class="token string">&quot;webpack-hot-middleware's client requires EventSource to work. &quot;</span> <span class="token operator">+</span>
      <span class="token string">'You should include a polyfill if you want to support this browser: '</span> <span class="token operator">+</span>
      <span class="token string">'https://developer.mozilla.org/en-US/docs/Web/API/Server-sent_events#Tools'</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token comment">// 开启链接</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>autoConnect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//...</span>
<span class="token comment">// SSEs 相关接口</span>
<span class="token keyword">function</span> <span class="token function">EventSourceWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> source<span class="token punctuation">;</span>
  <span class="token keyword">var</span> lastActivity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> listeners <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 检查服务是否中断</span>
  <span class="token keyword">var</span> timer <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> lastActivity <span class="token operator">&gt;</span> options<span class="token punctuation">.</span>timeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">handleDisconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> options<span class="token punctuation">.</span>timeout <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 设置回调函数</span>
  <span class="token keyword">function</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    source <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">window<span class="token punctuation">.</span>EventSource</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    source<span class="token punctuation">.</span>onopen <span class="token operator">=</span> handleOnline<span class="token punctuation">;</span>
    source<span class="token punctuation">.</span>onerror <span class="token operator">=</span> handleDisconnect<span class="token punctuation">;</span>
    source<span class="token punctuation">.</span>onmessage <span class="token operator">=</span> handleMessage<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">handleOnline</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>log<span class="token punctuation">)</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[HMR] connected'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lastActivity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 调用所有传入的 listeners</span>
  <span class="token keyword">function</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    lastActivity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> listeners<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      listeners<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">handleDisconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">clearInterval</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    source<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span>init<span class="token punctuation">,</span> options<span class="token punctuation">.</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">addMessageListener</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      listeners<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// EventSource 的包装函数，在多入口的配置中可以公用链接</span>
<span class="token keyword">function</span> <span class="token function">getEventSourceWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>window<span class="token punctuation">.</span>__whmEventSourceWrapper<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span>__whmEventSourceWrapper <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>window<span class="token punctuation">.</span>__whmEventSourceWrapper<span class="token punctuation">[</span>options<span class="token punctuation">.</span>path<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// cache the wrapper for other entries loaded on</span>
    <span class="token comment">// the same page with the same options.path</span>
    window<span class="token punctuation">.</span>__whmEventSourceWrapper<span class="token punctuation">[</span>options<span class="token punctuation">.</span>path<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">EventSourceWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> window<span class="token punctuation">.</span>__whmEventSourceWrapper<span class="token punctuation">[</span>options<span class="token punctuation">.</span>path<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 订阅 SSEs 服务并设置事件的回调函数</span>
<span class="token keyword">function</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">getEventSourceWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addMessageListener</span><span class="token punctuation">(</span>handleMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 服务端发送的维持信息</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>data <span class="token operator">==</span> <span class="token string">'\uD83D\uDC93'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token function">processMessage</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>warn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'Invalid HMR message: '</span> <span class="token operator">+</span> event<span class="token punctuation">.</span>data <span class="token operator">+</span> <span class="token string">'\n'</span> <span class="token operator">+</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//...</span>

<span class="token comment">// processUpdate 调用了 HMR API 检查更新模块，我们之后再看它</span>
<span class="token keyword">var</span> processUpdate <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./process-update'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> customHandler<span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">processMessage</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 用 payload 中的 action 代表事件</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>obj<span class="token punctuation">.</span>action<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">'building'</span><span class="token operator">:</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>log<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
          <span class="token string">'[HMR] bundle '</span> <span class="token operator">+</span>
            <span class="token punctuation">(</span>obj<span class="token punctuation">.</span>name <span class="token operator">?</span> <span class="token string">&quot;'&quot;</span> <span class="token operator">+</span> obj<span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">&quot;' &quot;</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token operator">+</span>
            <span class="token string">'rebuilding'</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">'built'</span><span class="token operator">:</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>log<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>
          <span class="token string">'[HMR] bundle '</span> <span class="token operator">+</span>
            <span class="token punctuation">(</span>obj<span class="token punctuation">.</span>name <span class="token operator">?</span> <span class="token string">&quot;'&quot;</span> <span class="token operator">+</span> obj<span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">&quot;' &quot;</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token operator">+</span>
            <span class="token string">'rebuilt in '</span> <span class="token operator">+</span>
            obj<span class="token punctuation">.</span>time <span class="token operator">+</span>
            <span class="token string">'ms'</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token comment">// fall through</span>
    <span class="token comment">// sync 事件真正让 client 去检查和更新模块</span>
    <span class="token keyword">case</span> <span class="token string">'sync'</span><span class="token operator">:</span>
      <span class="token comment">//...</span>
      <span class="token keyword">var</span> applyUpdate <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token comment">//... </span>
      <span class="token comment">// 中间一系列的 if-else 会检查服务端是否出现了错误</span>
      <span class="token comment">// 有则输出问题并设置 applyUpdate 的值</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>applyUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">processUpdate</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>hash<span class="token punctuation">,</span> obj<span class="token punctuation">.</span>modules<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>customHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">customHandler</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//...</span>
<span class="token punctuation">}</span>

<span class="token comment">// 供外部调用的 api，一般情况我们不会使用</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>module<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">subscribe</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token parameter">handler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      customHandler <span class="token operator">=</span> handler<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token comment">//...</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>和我们想的一样，client 内部订阅了 SSEs 服务并传入了<code>processMessage</code>回调函数处理服务端发送的事件，其中根据事件的不同它会选择输出构建信息或者检查更新模块，需要注意的是<code>processMessage</code>处理完<code>built</code>事件后会 fallthrough 到<code>sync</code>事件，而在<code>sync</code>事件中它会调用<code>processUpdate</code>方法，这就是 client 最终调用 HMR API 检查和更新模块的地方。</p> <p><code>processUpdate</code>函数代码在<a href="https://github.com/webpack-contrib/webpack-hot-middleware/blob/v2.25.0/process-update.js" target="_blank" rel="noopener noreferrer">webpack-hot-middleware/process-update.js<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>中：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// process-update.js</span>
<span class="token comment">/* global window __webpack_hash__ */</span>

<span class="token comment">// HMR API 由 webpack.HotModuleReplacementPlugin 插件提供</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>module<span class="token punctuation">.</span>hot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'[HMR] Hot Module Replacement is disabled.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> lastHash<span class="token punctuation">;</span>
<span class="token keyword">var</span> failureStatuses <span class="token operator">=</span> <span class="token punctuation">{</span> abort<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> fail<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> applyOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">//...</span>
  <span class="token comment">// hot.apply 使用的 options</span>
  <span class="token comment">// 包含一些失败情况下的处理方法，不需要考虑细节</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// __webpack_hash__ 是 webpack 设置的全局变量，唯一地标识本地代码</span>
<span class="token comment">// 所以这里 client 通过对比 hash 值判断是否需要更新模块</span>
<span class="token keyword">function</span> <span class="token function">upToDate</span><span class="token punctuation">(</span><span class="token parameter">hash</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>hash<span class="token punctuation">)</span> lastHash <span class="token operator">=</span> hash<span class="token punctuation">;</span>
  <span class="token keyword">return</span> lastHash <span class="token operator">==</span> __webpack_hash__<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 从这里的函数头就可以看出在服务端发送的 payload 数据里</span>
<span class="token comment">// 我们主要会用到 module hash、module id</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">hash<span class="token punctuation">,</span> moduleMap<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> reload <span class="token operator">=</span> options<span class="token punctuation">.</span>reload<span class="token punctuation">;</span>
  <span class="token comment">// 本地模块变动或进程正在等待调用 check（idle 状态）</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">upToDate</span><span class="token punctuation">(</span>hash<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> module<span class="token punctuation">.</span>hot<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'idle'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>log<span class="token punctuation">)</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'[HMR] Checking for updates on the server...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">check</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 执行检查更新</span>
  <span class="token keyword">function</span> <span class="token function">check</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> <span class="token function-variable function">cb</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> updatedModules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">handleError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//...</span>
      <span class="token comment">// 在更新过程中检查是否发生错误或者本地代码是否又发生了变动</span>
      <span class="token keyword">var</span> <span class="token function-variable function">applyCallback</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">applyErr<span class="token punctuation">,</span> renewedModules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>applyErr<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">handleError</span><span class="token punctuation">(</span>applyErr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">upToDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token function">check</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">logUpdates</span><span class="token punctuation">(</span>updatedModules<span class="token punctuation">,</span> renewedModules<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>

      <span class="token comment">// HMR API hot.apply 接口（继续更新进程）</span>
      module<span class="token punctuation">.</span><span class="token function">hot</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>applyOptions<span class="token punctuation">,</span> applyCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//...省略了处理 webpack2 的 apply promise</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// 这里就是关键了—— HMR API check 接口</span>
    <span class="token comment">// 它会测试所有加载的模块以进行更新，如果有更新，则应用它们。</span>
    module<span class="token punctuation">.</span>hot<span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> cb<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//...省略了处理 webpack2 check promise</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">logUpdates</span><span class="token punctuation">(</span><span class="token parameter">updatedModules<span class="token punctuation">,</span> renewedModules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//...</span>
    <span class="token comment">// 在调试器里输出一些构建信息，可忽略</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">handleError</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>hot<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">in</span> failureStatuses<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>warn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'[HMR] Cannot check for update (Full reload needed)'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'[HMR] '</span> <span class="token operator">+</span> <span class="token punctuation">(</span>err<span class="token punctuation">.</span>stack <span class="token operator">||</span> err<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token function">performReload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>warn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'[HMR] Update check failed: '</span> <span class="token operator">+</span> <span class="token punctuation">(</span>err<span class="token punctuation">.</span>stack <span class="token operator">||</span> err<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 在一些失败的情况下刷新浏览器</span>
  <span class="token keyword">function</span> <span class="token function">performReload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>reload<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>warn<span class="token punctuation">)</span> console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'[HMR] Reloading page'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      window<span class="token punctuation">.</span>location<span class="token punctuation">.</span><span class="token function">reload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>我们可以清楚地看到：首先<code>processUpdate</code>通过对比 Webpack 设置的全局变量<code>__webpack_hash__</code>判断本地代码是否发生了变动，有则调用<code>check</code>函数进行更新；在<code>check</code>函数中我们调用了 HMR API——<code>hot.check</code>和<code>hot.apply</code>做了模块更新和一些额外的检查。</p> <p>最后我简单总结一下 client 源码的内容：client 订阅了 middleware 的 SSEs 服务然后传入<code>processMessage</code>作为事件回调，它会根据不同的事件执行不同代码。其中<code>sync</code>事件最终会让<code>processMessage</code>调用<code>processUpdate</code>函数进行模块的检查和更新。</p> <h2 id="还有一件事"><a href="#还有一件事" class="header-anchor">#</a> 还有一件事</h2> <p>通过上面的源码分析我们可以清楚地看到 client 是如何工作的，但还有一个问题——它是什么时候被添加到我们的客户端代码中的？我们并没有在应用里引用<code>client.js</code>啊？</p> <p>还记得我们之前对 Webpack 客户端配置做的修改吗？“将<code>webpack-hot-middleware/client</code>加入客户端 Webpack 配置的入口配置（<code>entry</code>）数组中”，在实际操作中我们会这么做：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> clientConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./webpack.client.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// hotMiddleware下不能使用[name].[chunkhash]</span>
clientConfig<span class="token punctuation">.</span>output<span class="token punctuation">.</span>filename <span class="token operator">=</span> <span class="token string">'[name].js'</span><span class="token punctuation">;</span>
client<span class="token punctuation">.</span>entry <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'webpack-hot-middleware/client'</span><span class="token punctuation">,</span> client<span class="token punctuation">.</span>entry<span class="token punctuation">.</span>app<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre></div><p>以上的操作意味着 Webpack 会将<code>webpack-hot-middleware/client.js</code>作为一个入口文件并将它打包进我们的客户端代码中。</p> <p>为了验证这一点我们先将下面的代码添加到我们的 Webpack 客户端配置里：</p> <div class="language-js extra-class"><pre class="language-js"><code>optimization<span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token comment">// spliteChunks 相当于 CommonsChunkPlugins vendor</span>
  splitChunks<span class="token operator">:</span> <span class="token punctuation">{</span>
    chunks<span class="token operator">:</span> <span class="token string">'all'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Webpack4 的<code>splitChunks</code>配置相当于以前的<code>CommonsChunkPlugins</code>插件，它会将第三方公用代码抽离出我们的用户代码方便浏览器进行缓存。也就是说<code>webpack-hot-middleware/client</code>的代码被打包进<code>vender</code>里了。这样我们就可以很容易地在浏览器的资源管理器中找到它：</p> <p><img src="https://s1.ax1x.com/2020/04/30/JqBKXt.png" alt="vender"></p> <p>voilà！开发模式下 hotMiddleware client 就是这样随着我们的客户端代码一起运行的。</p> <h2 id="写在最后"><a href="#写在最后" class="header-anchor">#</a> 写在最后</h2> <p>至此，hotMiddleware 源码的主要内容已经介绍完毕，总结地来说这个中间件的工作分为两部分：服务端开启 SSEs 服务并注册 Webpack 编译钩子以在合适的时候向 client 发送事件；客户端 client 订阅 SSEs 服务并在事件发生时调用 HMR API 检查和更新模块。代码虽然看着很长，但主要内容并不多，其他更多的细节读者可以自行阅读查阅源码。</p> <p>希望以上内容对你有所帮助，如有任何问题你可以在 github 上找到我👉<a href="https://github.com/Styx11" target="_blank" rel="noopener noreferrer">Styx<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/FontEnd_Construction/devMiddleware.html" class="prev">
        devMiddleware 源码解析
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.0e898f27.js" defer></script><script src="/assets/js/2.7a648a06.js" defer></script><script src="/assets/js/8.0812829e.js" defer></script>
  </body>
</html>
