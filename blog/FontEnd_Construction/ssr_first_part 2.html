<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>SSR 构建流程（上） | Styx</title>
    <meta name="description" content="Just playing around">
    <meta name="generator" content="VuePress 1.3.1">
    
    
    <link rel="preload" href="/assets/css/0.styles.69dbb021.css" as="style"><link rel="preload" href="/assets/js/app.542af8a3.js" as="script"><link rel="preload" href="/assets/js/2.4c53de9c.js" as="script"><link rel="preload" href="/assets/js/8.1157f07c.js" as="script"><link rel="prefetch" href="/assets/js/10.73be2ece.js"><link rel="prefetch" href="/assets/js/11.e6c3acd2.js"><link rel="prefetch" href="/assets/js/12.7ca02aa2.js"><link rel="prefetch" href="/assets/js/13.c487dbc2.js"><link rel="prefetch" href="/assets/js/14.958d100c.js"><link rel="prefetch" href="/assets/js/15.15f28b4e.js"><link rel="prefetch" href="/assets/js/16.95df6ec0.js"><link rel="prefetch" href="/assets/js/17.2af160ad.js"><link rel="prefetch" href="/assets/js/18.c792796e.js"><link rel="prefetch" href="/assets/js/19.71dedb93.js"><link rel="prefetch" href="/assets/js/20.a0156c2c.js"><link rel="prefetch" href="/assets/js/21.fb350702.js"><link rel="prefetch" href="/assets/js/22.d5670fa1.js"><link rel="prefetch" href="/assets/js/23.1e6ef1a9.js"><link rel="prefetch" href="/assets/js/24.d2aad3ac.js"><link rel="prefetch" href="/assets/js/25.65d28a50.js"><link rel="prefetch" href="/assets/js/26.846dbf8c.js"><link rel="prefetch" href="/assets/js/27.b072ebe7.js"><link rel="prefetch" href="/assets/js/3.f82de149.js"><link rel="prefetch" href="/assets/js/4.2b2cd21e.js"><link rel="prefetch" href="/assets/js/5.25e441f8.js"><link rel="prefetch" href="/assets/js/6.70d1adeb.js"><link rel="prefetch" href="/assets/js/7.15d63579.js"><link rel="prefetch" href="/assets/js/9.f88959cf.js">
    <link rel="stylesheet" href="/assets/css/0.styles.69dbb021.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Styx</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Blog" class="dropdown-title"><span class="title">Blog</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/JavaScript/" class="nav-link">
  JavaScipt
</a></li><li class="dropdown-item"><!----> <a href="/blog/Node/" class="nav-link">
  Node
</a></li><li class="dropdown-item"><!----> <a href="/blog/FontEnd_Construction/" class="nav-link router-link-active">
  前端构建
</a></li></ul></div></div><div class="nav-item"><a href="/blog/Projects/" class="nav-link">
  Projects
</a></div><div class="nav-item"><a href="https://github.com/Styx11" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Blog" class="dropdown-title"><span class="title">Blog</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/JavaScript/" class="nav-link">
  JavaScipt
</a></li><li class="dropdown-item"><!----> <a href="/blog/Node/" class="nav-link">
  Node
</a></li><li class="dropdown-item"><!----> <a href="/blog/FontEnd_Construction/" class="nav-link router-link-active">
  前端构建
</a></li></ul></div></div><div class="nav-item"><a href="/blog/Projects/" class="nav-link">
  Projects
</a></div><div class="nav-item"><a href="https://github.com/Styx11" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/blog/FontEnd_Construction/" class="sidebar-link">Babel 转码器的使用</a></li><li><a href="/blog/FontEnd_Construction/use_eslint.html" class="sidebar-link">ESLint 规范代码</a></li><li><a href="/blog/FontEnd_Construction/module_basic.html" class="sidebar-link">ES6 Module 基本语法</a></li><li><a href="/blog/FontEnd_Construction/ssr_first_part.html" class="active sidebar-link">SSR 构建流程（上）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/FontEnd_Construction/ssr_first_part.html#前言" class="sidebar-link">前言</a></li><li class="sidebar-sub-header"><a href="/blog/FontEnd_Construction/ssr_first_part.html#开始一个基本的前端项目" class="sidebar-link">开始一个基本的前端项目</a></li><li class="sidebar-sub-header"><a href="/blog/FontEnd_Construction/ssr_first_part.html#为-webpack-附加额外的能力" class="sidebar-link">为 Webpack 附加额外的能力</a></li><li class="sidebar-sub-header"><a href="/blog/FontEnd_Construction/ssr_first_part.html#开始一个-vue-ssr-项目" class="sidebar-link">开始一个 Vue SSR 项目</a></li><li class="sidebar-sub-header"><a href="/blog/FontEnd_Construction/ssr_first_part.html#注意" class="sidebar-link">注意</a></li></ul></li><li><a href="/blog/FontEnd_Construction/ssr_second_part.html" class="sidebar-link">/blog/FontEnd_Construction/ssr_second_part.html</a></li><li><a href="/blog/FontEnd_Construction/ssr_third_part.html" class="sidebar-link">SSR 构建流程（下）</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="ssr-构建流程（上）"><a href="#ssr-构建流程（上）" class="header-anchor">#</a> SSR 构建流程（上）</h1> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>使用依赖版本以及样例源码参考 <a href="https://github.com/Styx11/vue-ssr-base" target="_blank" rel="noopener noreferrer">https://github.com/Styx11/vue-ssr-base<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>文章所描述的构建场景基于 Koa2 和 Webpack4</p> <p><strong>原创文章，转载请联系作者<a href="https://github.com/Styx11" target="_blank" rel="noopener noreferrer">Styx<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>！</strong></p></div> <h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>最近作者接触并学习了 Vue SSR ，即 Vue 应用的服务端渲染。因为服务端渲染开发环境的构建几乎涵盖了前端构建的大部分知识，所以作者觉得有必要对此进行一次完整的总结以应对今后工作的需要。在此之上作者创建了一个 <a href="https://github.com/Styx11/vue-ssr-base" target="_blank" rel="noopener noreferrer">Repo<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 作为一个具有普适性的 Vue SSR 项目的基础结构，其中只涉及了一个简单的 Vue 应用示例，重点在于展示所需要的构建配置和一个服务端开发模式，我相信其中对于中间件的适配方法一定会对你有所启发。</p> <p>我假设读者已经学习过 Vue SSR <a href="https://ssr.vuejs.org/zh/#%E4%BB%80%E4%B9%88%E6%98%AF%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AF%E6%B8%B2%E6%9F%93-ssr-%EF%BC%9F" target="_blank" rel="noopener noreferrer">官方文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，因为在这篇总结中我并不会向你介绍如何去写一个服务端渲染的应用，而是更多地关注文档之外的开发生态。</p> <p>我将这篇总结拆分成了上中下三部分，上篇关于开始一个 Vue SSR 项目所需的 Webpack 配置，中篇讨论与服务端的集成，下篇重点介绍基于 Koa2 和 Webpack4 的开发模式。</p> <h2 id="开始一个基本的前端项目"><a href="#开始一个基本的前端项目" class="header-anchor">#</a> 开始一个基本的前端项目</h2> <p>目前大部分的前端项目都是基于 Webpack 打包的，Webpack 在这个过程中扮演着“中间人”的角色：它基于 Node 生态，为开发者提供了现代 ECMAScript 的开发能力，将我们所有的依赖文件打包进一个可兼容的 Bundle 文件中，下面我们创建一组最基本的配置文件</p> <p><strong>0.</strong> 安装 Webpack4 相关的依赖：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">npm</span> <span class="token function">install</span> webpack webpack-cli webpack-merge rimraf cross-env --save-dev
</code></pre></div><p>我们使用了 <code>rimraf</code> 删除过期打包文件，<code>cross-env</code> 设置环境变量</p> <p><strong>1.</strong> 基于不重复原则(Don't repeat yourself - DRY)，我们保留一个 &quot;common(通用)&quot; 配置：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// config/webpack.base.js</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// NODE_ENV 可通过 cross-env 设置</span>
<span class="token keyword">const</span> isProd <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'production'</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  mode<span class="token operator">:</span> isProd
    <span class="token operator">?</span> <span class="token string">'production'</span>
    <span class="token operator">:</span> <span class="token string">'development'</span><span class="token punctuation">,</span>
  output<span class="token operator">:</span> <span class="token punctuation">{</span>
    path<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../dist'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    publicPath<span class="token operator">:</span> <span class="token string">'/dist/'</span><span class="token punctuation">,</span>
    filename<span class="token operator">:</span> <span class="token string">'[name].[contenthash].js'</span><span class="token comment">// hash of chunk content</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  devTool<span class="token operator">:</span> <span class="token string">'source-map'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>其中基于 hash 文件名的浏览器缓存可参考<a href="https://imweb.io/topic/5b6f224a3cb5a02f33c013ba" target="_blank" rel="noopener noreferrer">Webpack 4 如何优雅打包缓存文件<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><strong>2.</strong> 接下来我们基于 <code>webpack.base.js</code> 基础配置和 <code>webpack-merge</code> 创建客户端的打包配置文件：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// config/webpack.client.js</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> merge <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-merge'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> baseConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./webpack.base.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">merge</span><span class="token punctuation">(</span>baseConfig<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'client'</span><span class="token punctuation">,</span>
  entry<span class="token operator">:</span> <span class="token punctuation">{</span>
    client<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../src/client.entry.js'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>3.</strong> 最后在 <code>package.json</code> 中添加一条打包命令</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token comment">// package.json</span>
<span class="token property">&quot;script&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token property">&quot;build&quot;</span><span class="token operator">:</span> <span class="token string">&quot;rimraf dist &amp;&amp; cross-env NODE_ENV=production webpack --config config/webpack.client.js&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>以上就是最基本的配置文件了，你可以通过它使用 ES6 的 <code>import</code> 语法，并调用 <code>npm run build</code> 将所有依赖打包至单一文件中。</p> <h2 id="为-webpack-附加额外的能力"><a href="#为-webpack-附加额外的能力" class="header-anchor">#</a> 为 Webpack 附加额外的能力</h2> <p>我们有两个途径赋予 Webpack 额外的处理能力：</p> <ol><li><p>Loader: Webpack 只能理解 JavaScript 和 JSON 文件。loader 让 Webpack 能够去处理其他类型的文件，并将它们转换为有效模块，以供应用程序使用，以及被添加到依赖图中。</p></li> <li><p>Plugin: loader 用于转换某些类型的模块，而插件则可以用于执行范围更广的任务。包括：打包优化，资源管理，注入环境变量等，它应用于整个构建过程。</p></li></ol> <p>安装依赖：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">npm</span> <span class="token function">install</span> @babel/core @babel/preset-env babel-loader style-loader --save-dev
</code></pre></div><p>接下来我们在原有的配置中添加它们：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// config/webpack.base.js</span>
<span class="token comment">//...</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>

  <span class="token comment">// 原有的插件功能在 Webpack4 的 optimization 选项里直接提供</span>
  optimization<span class="token operator">:</span> <span class="token punctuation">{</span>
    minimize<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>

    <span class="token comment">// 更改为路径命名规则</span>
    namedModules<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    namedChunks<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>

    <span class="token comment">// 相当于 webpack.DefinePlugins 中设置 'process.env.NODE_ENV: JSON.stringifiy(...)'</span>
    nodeEnv<span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">||</span> <span class="token string">'development'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  module<span class="token operator">:</span> <span class="token punctuation">{</span>
    rules<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span> 
        test<span class="token operator">:</span> <span class="token regex">/\.css$/</span><span class="token punctuation">,</span>
        use<span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token string">'css-loader'</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>客户端配置：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// config/webpack.client.js</span>
<span class="token comment">// ...</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">merge</span><span class="token punctuation">(</span>baseConfig<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token comment">//...</span>

  module<span class="token operator">:</span> <span class="token punctuation">{</span>
    rules<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        test<span class="token operator">:</span> <span class="token regex">/\.js$/</span><span class="token punctuation">,</span>
        exclude<span class="token operator">:</span> <span class="token regex">/node_modules/</span><span class="token punctuation">,</span>
        use<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">'babel-loader'</span> <span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  optimization<span class="token operator">:</span> <span class="token punctuation">{</span>

    <span class="token comment">// 默认使用 webpack v4+ 提供的全新的通用分块策略</span>
    <span class="token comment">// 以下注释以 webpack v4 以下版本作对比</span>
    <span class="token comment">// chunk 相关配置只应用在 client</span>

    <span class="token comment">// spliteChunks 相当于 CommonsChunkPlugins vendor</span>
    splitChunks<span class="token operator">:</span> <span class="token punctuation">{</span>
      chunks<span class="token operator">:</span> <span class="token string">'all'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token comment">// runtimeChunks 相当于 CommonsChunkPlugins 中的 'runtime'</span>
    <span class="token comment">// 这将 runtime chunk 抽离出来公用</span>
    runtimeChunk<span class="token operator">:</span> <span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token string">'runtime'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="custom-block warning"><p class="custom-block-title">注意</p> <p>在 Webpack4 中原来由 Plugin 提供的功能，例如 <code>CommonsChunkPlugins</code> 和 <code>webpack.DefinePlugins</code> 等，通过<code>optimization</code>相关选项原生提供
具体可参考<a href="https://webpack.docschina.org/configuration/optimization/" target="_blank" rel="noopener noreferrer">Webpack optimization<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <p>通过使用 <code>babel-loader</code>和配置<code>.babelrc</code>， 我们就能够使用最新的 ES 语法并通过转译使其运行在老版本浏览器中</p> <h2 id="开始一个-vue-ssr-项目"><a href="#开始一个-vue-ssr-项目" class="header-anchor">#</a> 开始一个 Vue SSR 项目</h2> <p>无论是 React 还是 Vue，它们各自的 SSR 都是一种开发方案：试图解决自前后端分离思想出现以来一直存在的问题——首屏载入时间过长。这似乎是一个不可绕开的话题，因为如果想要前后端分离，那么大量的前端资源就要打包进少量的文件中直接发送给客户端，这样首屏载入时间就会成为一个绝对的性能瓶颈。</p> <p>SSR 方案通过在前后端之间加入了 Node 做中间层，让这个中间层提前渲染好应用程序的“快照”，也就是字符串形式的静态标记发送给用户，之后再发送打包资源并“激活”客户端程序，极大改善了 SEO 和首屏渲染时间，这也是这类方案的中心思想。</p> <p>Vue SSR 官方文档的一张流程图很好的展示了这一点：
<img src="https://cloud.githubusercontent.com/assets/499550/17607895/786a415a-5fee-11e6-9c11-45a2cfdf085c.png" alt="服务端渲染流程"></p> <p>那么对于我们来说这就意味着需要两种 Webpack 配置文件：一种以 <code>server.entry.js</code> 为入口的服务端配置，另一种以 <code>client.entry.js</code> 为入口的客户端配置，以供“服务端渲染”和“客户端激活”。</p> <p>我们安装 Vue SSR 相关依赖</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">npm</span> <span class="token function">install</span> vue-template-compiler vue-loader --save-dev
</code></pre></div><p>其中 <code>vue-template-compiler</code> 必须与 <code>vue</code> 版本匹配</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">npm</span> <span class="token function">install</span> vue vue-server-renderer --save
</code></pre></div><p>我们的代码结构：</p> <div class="language- extra-class"><pre class="language-text"><code>src
├── components
│   ├── ...
├── App.vue
├── app.js # 通用 entry(universal entry)
├── client.entry.js # 仅运行于浏览器
└── server.entry.js # 仅运行于服务器
</code></pre></div><p>现在修改 base、client、server 三处配置文件</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// config/webpack.base.js</span>
<span class="token keyword">const</span> VueLoaderPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vue-loader/lib/plugin-webpack4'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//...</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">//...</span>
  module<span class="token operator">:</span> <span class="token punctuation">{</span>
    rules<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span> test<span class="token operator">:</span> <span class="token regex">/\.vue$/</span><span class="token punctuation">,</span> use<span class="token operator">:</span> <span class="token string">'vue-loader'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>

      <span class="token comment">// 它会应用到普通的 `.css` 文件</span>
      <span class="token comment">// 以及 `.vue` 文件中的 `&lt;style&gt;` 块</span>
      <span class="token comment">// 使用 render template 选项时会提取并注入 css 资源</span>
      <span class="token punctuation">{</span> 
        test<span class="token operator">:</span> <span class="token regex">/\.css$/</span><span class="token punctuation">,</span>
        use<span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token string">'vue-style-loader'</span><span class="token punctuation">,</span>
          <span class="token string">'css-loader'</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token comment">// 将你定义过的其它规则复制并应用到 .vue 文件里相应语言的块。</span>
    <span class="token comment">// 例如，如果你有一条匹配 /\.js$/ 的规则，那么它会应用到 .vue 文件里的 &lt;script&gt; 块。</span>
    <span class="token keyword">new</span> <span class="token class-name">VueLoaderPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// config/webpack.client.js</span>
<span class="token comment">// ...</span>
<span class="token keyword">const</span> VueSSRClientPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vue-server-renderer/client-plugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">merge</span><span class="token punctuation">(</span>baseConfig<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token comment">//...</span>

  plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token comment">// 定义vue环境变量</span>
    <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>DefinePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token string">'process.env.VUE_ENV'</span><span class="token operator">:</span> <span class="token string">'&quot;client&quot;'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">// 创建客户端清单，以供 createBundleRender 使用</span>
    <span class="token keyword">new</span> <span class="token class-name">VueSSRClientPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>针对 Node 环境的配置，我们会将其打包为 <code>createBundleRenderer</code> 使用的<code>json</code>文件</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// config/webpack.server.js</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> merge <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-merge'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> webpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> baseConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./webpack.base'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> nodeExternals <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-node-externals'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> VueSSRServerPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vue-server-renderer/server-plugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">merge</span><span class="token punctuation">(</span>baseConfig<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'server'</span><span class="token punctuation">,</span>
  target<span class="token operator">:</span> <span class="token string">'node'</span><span class="token punctuation">,</span>
  entry<span class="token operator">:</span> <span class="token punctuation">{</span>
    server<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../src/server.entry.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  output<span class="token operator">:</span> <span class="token punctuation">{</span>
    libraryTarget<span class="token operator">:</span> <span class="token string">'commonjs2'</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>

  <span class="token comment">// 外置 node 环境依赖</span>
  externals<span class="token operator">:</span> <span class="token function">nodeExternals</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    whitelist<span class="token operator">:</span> <span class="token regex">/\.css$/</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

  plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>DefinePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token string">'process.env.VUE_ENV'</span><span class="token operator">:</span> <span class="token string">'&quot;server&quot;'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">// 输出json文件</span>
    <span class="token keyword">new</span> <span class="token class-name">VueSSRServerPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>完整的配置参考<a href="https://github.com/Styx11/vue-ssr-base/tree/master/config" target="_blank" rel="noopener noreferrer">https://github.com/Styx11/vue-ssr-base/tree/master/config<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>这些配置的使用有以下几个前提：</p> <ul><li>使用 <code>createBundleRenderer</code> 创建服务端渲染实例</li> <li>在上一点的前提下以<code>server.entry.js</code>为入口使用<code>VueSSRServerPlugin</code>插件打包为一个<code>json</code>文件</li> <li>在使用 <code>template</code> 的前提下使用 <code>clientManifest</code> 客户端清单自动注入数据预取指令和资源标签</li></ul> <p>以上这些都是为最优化的资源注入和更高效的开发模式做基础的。</p> <p>最后我们添加打包脚本：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token comment">// package.json</span>
<span class="token punctuation">{</span>
  <span class="token comment">//...</span>
  <span class="token property">&quot;script&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;build&quot;</span><span class="token operator">:</span> <span class="token string">&quot;rimraf dist &amp;&amp; npm run build:client &amp;&amp; npm run build:server&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;build:client&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cross-env NODE_ENV=production webpack --config config/webpack.client.js&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;build:server&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cross-env NODE_ENV=production webpack --config config/webpack.server.js&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>执行指令：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">npm</span> run build
</code></pre></div><p>你就能在<code>dist</code>文件夹下看到带有 hash 文件名的服务端客户端打包文件，以及抽离出的公用代码。</p> <p>我们将在中篇展示如何在服务端使用它们。</p> <h2 id="注意"><a href="#注意" class="header-anchor">#</a> 注意</h2> <p>我们的构建环境基于 Webpack4 ，其中在将<code>es6</code>模块打包输出为<code>commonjs2</code>模块供服务端使用时，Webpack 会将<code>es6</code>模块导出的内容挂载在<code>module</code>对象上，而不是像<a href="https://ssr.vuejs.org/zh/guide/structure.html#%E4%BD%BF%E7%94%A8-webpack-%E7%9A%84%E6%BA%90%E7%A0%81%E7%BB%93%E6%9E%84" target="_blank" rel="noopener noreferrer">官方文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>所描述的覆盖它，在这种情况下<code>createBundleRenderer</code>就不能正确的获取到提供的<code>createApp</code>函数（已知的 <code>vue-server-renderer</code> v2.6.11 版本）。</p> <p>所以我们直接在<a href="https://github.com/Styx11/vue-ssr-demo/blob/master/src/server.entry.js" target="_blank" rel="noopener noreferrer"><code>server.entry.js</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>里使用<code>commonjs2</code>模块语法做中间适配以解决不同模块语法的转换问题。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/FontEnd_Construction/module_basic.html" class="prev">
        ES6 Module 基本语法
      </a></span> <span class="next"><a href="/blog/FontEnd_Construction/ssr_second_part.html">
        /blog/FontEnd_Construction/ssr_second_part.html
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.542af8a3.js" defer></script><script src="/assets/js/2.4c53de9c.js" defer></script><script src="/assets/js/8.1157f07c.js" defer></script>
  </body>
</html>
