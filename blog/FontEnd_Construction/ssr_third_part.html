<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>SSR 构建流程（下） | Styx</title>
    <meta name="description" content="Just playing around">
    <meta name="generator" content="VuePress 1.3.1">
    
    
    <link rel="preload" href="/assets/css/0.styles.69dbb021.css" as="style"><link rel="preload" href="/assets/js/app.7dcead37.js" as="script"><link rel="preload" href="/assets/js/2.7a648a06.js" as="script"><link rel="preload" href="/assets/js/11.5c4447d0.js" as="script"><link rel="prefetch" href="/assets/js/10.b0a9b689.js"><link rel="prefetch" href="/assets/js/12.f923dd2a.js"><link rel="prefetch" href="/assets/js/13.1af22a96.js"><link rel="prefetch" href="/assets/js/14.3ee17ff3.js"><link rel="prefetch" href="/assets/js/15.61553de6.js"><link rel="prefetch" href="/assets/js/16.f27511f4.js"><link rel="prefetch" href="/assets/js/17.86379843.js"><link rel="prefetch" href="/assets/js/18.a86d04a7.js"><link rel="prefetch" href="/assets/js/19.aaed5981.js"><link rel="prefetch" href="/assets/js/20.9ca7f403.js"><link rel="prefetch" href="/assets/js/21.4b5b34b9.js"><link rel="prefetch" href="/assets/js/22.edbdae57.js"><link rel="prefetch" href="/assets/js/23.aab33ae5.js"><link rel="prefetch" href="/assets/js/24.6c705efe.js"><link rel="prefetch" href="/assets/js/25.5914ddbe.js"><link rel="prefetch" href="/assets/js/26.be102ea6.js"><link rel="prefetch" href="/assets/js/27.54946d8a.js"><link rel="prefetch" href="/assets/js/28.3304d296.js"><link rel="prefetch" href="/assets/js/3.89103ff0.js"><link rel="prefetch" href="/assets/js/4.2b2cd21e.js"><link rel="prefetch" href="/assets/js/5.25e441f8.js"><link rel="prefetch" href="/assets/js/6.70d1adeb.js"><link rel="prefetch" href="/assets/js/7.8b6ab45f.js"><link rel="prefetch" href="/assets/js/8.1e4b4acf.js"><link rel="prefetch" href="/assets/js/9.1b1c0914.js">
    <link rel="stylesheet" href="/assets/css/0.styles.69dbb021.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Styx</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Blog" class="dropdown-title"><span class="title">Blog</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/JavaScript/" class="nav-link">
  JavaScipt
</a></li><li class="dropdown-item"><!----> <a href="/blog/Node/" class="nav-link">
  Node
</a></li><li class="dropdown-item"><!----> <a href="/blog/FontEnd_Construction/" class="nav-link router-link-active">
  前端构建
</a></li></ul></div></div><div class="nav-item"><a href="/blog/Projects/" class="nav-link">
  Projects
</a></div><div class="nav-item"><a href="https://github.com/Styx11" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Blog" class="dropdown-title"><span class="title">Blog</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog/JavaScript/" class="nav-link">
  JavaScipt
</a></li><li class="dropdown-item"><!----> <a href="/blog/Node/" class="nav-link">
  Node
</a></li><li class="dropdown-item"><!----> <a href="/blog/FontEnd_Construction/" class="nav-link router-link-active">
  前端构建
</a></li></ul></div></div><div class="nav-item"><a href="/blog/Projects/" class="nav-link">
  Projects
</a></div><div class="nav-item"><a href="https://github.com/Styx11" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/blog/FontEnd_Construction/" class="sidebar-link">Babel 转码器的使用</a></li><li><a href="/blog/FontEnd_Construction/use_eslint.html" class="sidebar-link">ESLint 规范代码</a></li><li><a href="/blog/FontEnd_Construction/module_basic.html" class="sidebar-link">ES6 Module 基本语法</a></li><li><a href="/blog/FontEnd_Construction/ssr_first_part.html" class="sidebar-link">SSR 构建流程（上）</a></li><li><a href="/blog/FontEnd_Construction/ssr_second_part.html" class="sidebar-link">SSR 构建流程（中）</a></li><li><a href="/blog/FontEnd_Construction/ssr_third_part.html" class="active sidebar-link">SSR 构建流程（下）</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/FontEnd_Construction/ssr_third_part.html#前言" class="sidebar-link">前言</a></li><li class="sidebar-sub-header"><a href="/blog/FontEnd_Construction/ssr_third_part.html#思路" class="sidebar-link">思路</a></li><li class="sidebar-sub-header"><a href="/blog/FontEnd_Construction/ssr_third_part.html#准备" class="sidebar-link">准备</a></li><li class="sidebar-sub-header"><a href="/blog/FontEnd_Construction/ssr_third_part.html#devmiddleware" class="sidebar-link">devMiddleware</a></li></ul></li><li><a href="/blog/FontEnd_Construction/devMiddleware.html" class="sidebar-link">devMiddlware 源码解析</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="ssr-构建流程（下）"><a href="#ssr-构建流程（下）" class="header-anchor">#</a> SSR 构建流程（下）</h1> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>使用依赖版本以及样例源码参考 <a href="https://github.com/Styx11/vue-ssr-base" target="_blank" rel="noopener noreferrer">https://github.com/Styx11/vue-ssr-base<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>文章所描述的构建场景基于 Koa2 和 Webpack4 并假定读者学习过 Vue SSR <a href="https://ssr.vuejs.org/zh/#%E4%BB%80%E4%B9%88%E6%98%AF%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AF%E6%B8%B2%E6%9F%93-ssr-%EF%BC%9F" target="_blank" rel="noopener noreferrer">官方文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><strong>原创文章，转载请联系作者<a href="https://github.com/Styx11" target="_blank" rel="noopener noreferrer">Styx<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>！</strong></p></div> <h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>通过<a href="/blog/FontEnd_Construction/ssr_second_part.html">中篇</a>的介绍我们将 Vue SSR 应用与 Koa2 服务器结合，并通过组合中间件提供了路由、文件服务功能。我们使用的<code>renderer</code>都是通过直接引用打包文件创建的：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// server.js</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> createBundleRenderer <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vue-server-renderer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> clientManifest <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./dist/vue-ssr-client-manifest.json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> serverBundle <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./dist/vue-ssr-bundle.json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> template <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'./src/template/index.html'</span><span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> renderer <span class="token operator">=</span> <span class="token function">createBundleRenderer</span><span class="token punctuation">(</span>serverBundle<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  runInNewContext<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  clientManifest<span class="token punctuation">,</span>
  template
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这是很自然的，但是在开发过程中每次修改<code>src</code>目录下的源文件时都要重新调用<code>npm run build</code>打包文件并刷新浏览器，这大大降低了我们的开发效率。</p> <p>那么在这里，我将向你展示如何通过适配 Webpack4 中间件<code>devMiddleware</code>和<code>hotMiddleware</code>来与现有的 Koa2 服务器整合以提供高效的开发模式。这是我目前踩坑最多的构建过程，因为它不在 Vue SSR 文档的介绍里，要求我们更多地关注整个前端开发生态、查阅它们的源码、参考旧版本库的模式从而找到一个适配方案。</p> <p>另外在这个过程中我发现了解中间件在源码层面的运行方式是有必要的，所以我额外写了两篇源码解析来总结我所学到的，希望对你有所帮助：<a href="/blog/FontEnd_Construction/devMiddleware.html">devMiddleware 源码解析</a>、<a href="/blog/FontEnd_Construction/hotMiddleware.html">hotMiddleware 源码解析</a>。</p> <h2 id="思路"><a href="#思路" class="header-anchor">#</a> 思路</h2> <p>Vue SSR 官方在<a href="https://ssr.vuejs.org/zh/guide/bundle-renderer.html#%E4%BD%BF%E7%94%A8%E5%9F%BA%E6%9C%AC-ssr-%E7%9A%84%E9%97%AE%E9%A2%98" target="_blank" rel="noopener noreferrer">Bundle Renderer 指引<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>中为我们提供了构建开发模式的思路——读取更新后的<code>bundle</code>从而更新<code>renderer</code>。这样服务器就能使用新的<code>renderer</code>去创建静态标记并发送更新后的打包文件。这个模式之所以成立是因为<code>createBundleRenderer</code>可以使用传入的<code>template</code>和<code>clientManifest</code>自动注入关键资源和数据预取指令。例如当我们使用 Webpack 提供的<code>chunkhash</code>作为浏览器缓存策略时，编译文件的名称就会改变，这样自动注入资源就显得额外重要，并且它还提供内置的<code>source-map</code>的支持。</p> <p>那么综上所述，对于服务端，我们需要在两个 Webpack 实例上注册编译钩子获取更新后的<code>bundle</code>并重新创建<code>renderer</code>；对于客户端，<code>webpack-dev-middleware</code>中间件将处理相关请求，为客户端提供更新后的<code>bundle</code>文件。</p> <h2 id="准备"><a href="#准备" class="header-anchor">#</a> 准备</h2> <p>现在让我们在原来的样例库中添加一个专门存放<a href="https://github.com/Styx11/vue-ssr-base/blob/master/lib/devMiddleware.js" target="_blank" rel="noopener noreferrer">开发模式逻辑<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>的文件。因为我们需要监听供“服务端渲染”和“客户端激活”的两组文件，所以我们让它会返回一组<code>Promise</code>以便让服务器在一切准备就绪后再开始监听请求：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// lib/devMiddleware.js</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">app</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> serverRes<span class="token punctuation">,</span> clientRes<span class="token punctuation">;</span>
  <span class="token keyword">const</span> serverPromise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> serverRes <span class="token operator">=</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> clientPromise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> clientRes <span class="token operator">=</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//... resolve here</span>

  <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>serverPromise<span class="token punctuation">,</span> clientPromise<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>由于需要监听两组文件，所以我们之后会分别创建针对服务端和客户端的 devMiddleware 并在相关的编译钩子中<code>resolve</code>它们。</p> <p>之后在<a href="https://github.com/Styx11/vue-ssr-base/blob/master/server.js" target="_blank" rel="noopener noreferrer">服务端<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>引用并<strong>只</strong>在开发模式使用它：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// server.js</span>
<span class="token comment">//...</span>
<span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> isProd <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'production'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> devMiddleware <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./lib/devMiddleware.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//...</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token comment">//...</span>

router<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token comment">/* ... */</span><span class="token punctuation">)</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token comment">/* ... */</span><span class="token punctuation">)</span>

<span class="token comment">// 最后挂载通配符路由，因为需要让中间件处理特定请求</span>
<span class="token keyword">const</span> <span class="token function-variable function">listen</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>route<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>route<span class="token punctuation">.</span><span class="token function">allowedMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Server running at localhost:8080'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

isProd
  <span class="token operator">?</span> <span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token operator">:</span> <span class="token function">devMiddleware</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>listen<span class="token punctuation">)</span>

</code></pre></div><p>最后添加开发模式的运行脚本：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token comment">// package,json</span>
<span class="token property">&quot;script&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token property">&quot;dev&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cross-env NODE_ENV=development node server&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;start&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cross-env NODE_ENV=production node server&quot;</span><span class="token punctuation">,</span>
  <span class="token comment">//...</span>
<span class="token punctuation">}</span>
<span class="token comment">//...</span>
</code></pre></div><p><code>npm run dev</code>会让服务器在开发模式下运行并使用中间件以提供重载功能。</p> <p>接下来我们添加这两个中间件的相关代码让这一切运行起来。</p> <h2 id="devmiddleware"><a href="#devmiddleware" class="header-anchor">#</a> devMiddleware</h2> <p><code>webpack-dev-middleware</code>是<code>webpack-dev-server</code>内部使用的中间件，它可以提供更高的灵活性并与现有的服务器结合。先来安装依赖：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">npm</span> <span class="token function">install</span> webpack-dev-middleware@3.7.2 --save-dev
</code></pre></div><p>然后仿照 Express 那样的方式创建两个用于服务端和客户端入口文件的中间件：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// lib/devMiddleware.js</span>
<span class="token keyword">const</span> webpack <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> webpackDevMiddleware <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-dev-middleware'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> clientConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../config/webpack.client.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> serverConfig <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../config/webpack.server.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">app</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> serverRes<span class="token punctuation">,</span> clientRes<span class="token punctuation">;</span>
  <span class="token keyword">const</span> serverPromise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> serverRes <span class="token operator">=</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> clientPromise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> clientRes <span class="token operator">=</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 目前只是创建并返回中间件</span>
  <span class="token keyword">const</span> <span class="token function-variable function">createDevMiddleware</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">complier<span class="token punctuation">,</span> config</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> middleware <span class="token operator">=</span> <span class="token function">webpackDevMiddleware</span><span class="token punctuation">(</span>complier<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      publicPath<span class="token operator">:</span> config<span class="token punctuation">.</span>output<span class="token punctuation">.</span>publicPath<span class="token punctuation">,</span>
      noInfo<span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//... resolve here</span>

    <span class="token keyword">return</span> middleware<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> clientComplier <span class="token operator">=</span> <span class="token function">webpack</span><span class="token punctuation">(</span>clientConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> clientDevMiddleware <span class="token operator">=</span> <span class="token function">createDevMiddleware</span><span class="token punctuation">(</span>clientComplier<span class="token punctuation">,</span> clientConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> serverComplier <span class="token operator">=</span> <span class="token function">webpack</span><span class="token punctuation">(</span>serverConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> serverDevMiddleware <span class="token operator">=</span> <span class="token function">createDevMiddleware</span><span class="token punctuation">(</span>serverComplier<span class="token punctuation">,</span> serverConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 只是仿照 express 的方式，并不适用与 koa2</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>clientDevMiddleware<span class="token punctuation">)</span><span class="token punctuation">;</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>serverDevMiddleware<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>serverPromise<span class="token punctuation">,</span> clientPromise<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>目前这个模式并不适用于我们的 Koa2 服务器，因为通过<code>middleware</code>对象的<a href="https://github.com/webpack/webpack-dev-middleware/blob/v3.7.2/lib/middleware.js" target="_blank" rel="noopener noreferrer">源码<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>我们可以知道 devMiddleware 内部使用的是类 Express API，直接用在服务器上会报错。所以我们做以下适配：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// lib/devMiddleware.js</span>
<span class="token comment">//...</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">app</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">//...</span>

  <span class="token keyword">const</span> <span class="token function-variable function">createDevMiddleware</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">complier<span class="token punctuation">,</span> config</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> middleware <span class="token operator">=</span> <span class="token function">webpackDevMiddleware</span><span class="token punctuation">(</span>complier<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      publicPath<span class="token operator">:</span> config<span class="token punctuation">.</span>output<span class="token punctuation">.</span>publicPath<span class="token punctuation">,</span>
      noInfo<span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 适配 res 相关的方法</span>
    <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// middleware 内部会返回一个 promise</span>
      <span class="token keyword">await</span> <span class="token function">middleware</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>req<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token function-variable function">setHeader</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token punctuation">,</span> header</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> ctx<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> header<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function-variable function">getHeader</span><span class="token operator">:</span> <span class="token parameter">name</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> ctx<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function-variable function">end</span><span class="token operator">:</span> <span class="token parameter">content</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> content
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        locals<span class="token operator">:</span> ctx<span class="token punctuation">.</span>state<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">//...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这个时候在开发模式下我们的服务器就可以在源码变动的时候为客户端提供更新后的打包文件了，这是第一部分。</p> <p>第二部分就是关键了，我们要为服务端和客户端的 Webpack 实例添加编译钩子获取更新后的<code>bundle</code>从而创建新的<code>render</code>，这也是<code>Promise</code>被<code>resolve</code>的时机：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// lib/devMiddleware.js</span>
<span class="token comment">//...</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> createBundleRenderer <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vue-server-renderer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 添加 render 相关参数</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">app<span class="token punctuation">,</span> render</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> serverBundle<span class="token punctuation">,</span> clientManifest<span class="token punctuation">;</span>
  <span class="token keyword">let</span> serverResolve<span class="token punctuation">,</span> clientResolve<span class="token punctuation">;</span>
  <span class="token keyword">const</span> serverPromise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> serverResolve <span class="token operator">=</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> clientPromise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> clientResolve <span class="token operator">=</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 因为两端都要注册钩子，所以在这里一块处理</span>
  <span class="token keyword">const</span> <span class="token function-variable function">createDevMiddleware</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">complier<span class="token punctuation">,</span> config<span class="token punctuation">,</span> side</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">//...</span>
    <span class="token keyword">const</span> isClient <span class="token operator">=</span> side <span class="token operator">===</span> <span class="token string">'client'</span><span class="token punctuation">;</span>

    <span class="token comment">// 编译完成钩子</span>
    complier<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>done<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'renderer-rebuild'</span><span class="token punctuation">,</span> <span class="token parameter">state</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      stats <span class="token operator">=</span> stats<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      stats<span class="token punctuation">.</span>errors<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      stats<span class="token punctuation">.</span>warnings<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">warning</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>warning<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>stats<span class="token punctuation">.</span>errors<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

      <span class="token comment">// 根据 side 选择 serverBundle 或 clientManifest 路径</span>
      <span class="token comment">// 并使用 devMiddleware 默认的 memory-fs 内存文件系统获取编译文件</span>
      <span class="token keyword">const</span> sPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../dist/vue-ssr-server-bundle.json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> cPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../dist/vue-ssr-client-manifest.json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 和 complier.outputFileSystem 引用同一个文件系统</span>
      middleware<span class="token punctuation">.</span>fileSystem<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>isClient <span class="token operator">?</span> cPath <span class="token operator">:</span> sPath<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> file</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">throw</span> err<span class="token punctuation">;</span>

        <span class="token comment">// 重新创建 renderer</span>
        <span class="token comment">// 因为要与服务端共享，所以我们将 renderer 和 template 传入一个 render 全局对象中</span>
        <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        isClient <span class="token operator">?</span> clientManifest <span class="token operator">=</span> res <span class="token operator">:</span> serverBundle <span class="token operator">=</span> res<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>clientManifest <span class="token operator">&amp;&amp;</span> serverBundle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          render<span class="token punctuation">.</span>renderer <span class="token operator">=</span> <span class="token function">createBundleRenderer</span><span class="token punctuation">(</span>serverBundle<span class="token punctuation">,</span> <span class="token punctuation">{</span>
            template<span class="token operator">:</span> render<span class="token punctuation">.</span>template<span class="token punctuation">,</span>
            clientManifest<span class="token punctuation">,</span>
            runInNewContext<span class="token operator">:</span> <span class="token boolean">false</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        isClient <span class="token operator">?</span> <span class="token function">clientResolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">serverResolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//...</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">//...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>紧接着修改<code>server.js</code>在开发模式下创建<code>renderer</code>的相关代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//server.js</span>
<span class="token keyword">let</span> renderer<span class="token punctuation">;</span>
<span class="token keyword">const</span> isProd <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'production'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> devMiddleware <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./lib/devMiddleware.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> template <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">'./src/template/index.html'</span><span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> render <span class="token operator">=</span> <span class="token punctuation">{</span> renderer<span class="token punctuation">,</span> template <span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>isProd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> createBundleRenderer <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'vue-server-renderer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> serverBundle <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./dist/vue-ssr-server-bundle.json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> clientManifest <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./dist/vue-ssr-client-manifest.json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  render<span class="token punctuation">.</span>renderer <span class="token operator">=</span> <span class="token function">createBundleRenderer</span><span class="token punctuation">(</span>serverBundle<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    template<span class="token operator">:</span> render<span class="token punctuation">.</span>template<span class="token punctuation">,</span>
    runInNewContext<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    clientManifest<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">//...</span>

router<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token comment">/* ... */</span><span class="token punctuation">)</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">//...</span>
  <span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token punctuation">{</span> title<span class="token operator">:</span> <span class="token string">'Hello SSR'</span><span class="token punctuation">,</span> url<span class="token operator">:</span> ctx<span class="token punctuation">.</span>url <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// 修改为 render.renderer</span>
    <span class="token keyword">const</span> html <span class="token operator">=</span> <span class="token keyword">await</span> render<span class="token punctuation">.</span>renderer<span class="token punctuation">.</span><span class="token function">renderToString</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//...</span>
    ctx<span class="token punctuation">.</span>state<span class="token punctuation">.</span>html <span class="token operator">=</span> html<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//...</span>

isProd
  <span class="token operator">?</span> <span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token operator">:</span> <span class="token function">devMiddlware</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> render<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>listen<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>现在当我们进入开发模式时，<code>renderer</code>的创建就交给<code>lib/devMiddleware.js</code>中注册的钩子函数了，并且服务器只有在首次编译完成后才会监听请求（等待<code>Promise</code>）。</p> <p>让我们来测试一下目前的开发模式，运行命令<code>npm run dev</code>后你可以在终端看到编译信息并且最后会提示<code>Server running at localhost</code>表明服务器开始监听：</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token punctuation">..</span>.
<span class="token punctuation">[</span>./src/App.vue<span class="token punctuation">]</span> <span class="token number">1.09</span> KiB <span class="token punctuation">{</span>main<span class="token punctuation">}</span> <span class="token punctuation">[</span>built<span class="token punctuation">]</span>
<span class="token punctuation">[</span>./src/app.js<span class="token punctuation">]</span> <span class="token number">310</span> bytes <span class="token punctuation">{</span>main<span class="token punctuation">}</span> <span class="token punctuation">[</span>built<span class="token punctuation">]</span>
<span class="token punctuation">[</span>./src/client.entry.js<span class="token punctuation">]</span> <span class="token number">175</span> bytes <span class="token punctuation">{</span>main<span class="token punctuation">}</span> <span class="token punctuation">[</span>built<span class="token punctuation">]</span>
<span class="token punctuation">[</span>./src/router/index.js<span class="token punctuation">]</span> <span class="token number">469</span> bytes <span class="token punctuation">{</span>main<span class="token punctuation">}</span> <span class="token punctuation">[</span>built<span class="token punctuation">]</span>
    + <span class="token number">29</span> hidden modules
ℹ ｢wdm｣: Compiled successfully.
Server running at localhost:8080
</code></pre></div><p>打开浏览器进入地址<code>localhost:8080</code>可以看到我们客户端应用，这个时候我们随便更改一下<code>src</code>目录下应用的标签部分并保存，可以在终端看到有新的编译信息输出，同时我们刷新浏览器可以发现内容有所变化。这就是我们在这一部分的目的了——更新内容而无需重新调用编译命令，这让我们的开发变得更加高效。
<img src="https://s1.ax1x.com/2020/04/22/JNmOcn.gif" alt=""></p> <p>但是这样还不够，我们还是需要手动刷新浏览器并且在这个过程中应用状态会丢失，导致一切都得重新来过。这个时候模块热替换HMR（Hot Module Replacement）就可以让开发效率更上一层楼。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/FontEnd_Construction/ssr_second_part.html" class="prev">
        SSR 构建流程（中）
      </a></span> <span class="next"><a href="/blog/FontEnd_Construction/devMiddleware.html">
        devMiddlware 源码解析
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.7dcead37.js" defer></script><script src="/assets/js/2.7a648a06.js" defer></script><script src="/assets/js/11.5c4447d0.js" defer></script>
  </body>
</html>
